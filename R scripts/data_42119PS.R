attach(museumeverything)

library(runjags)
library(rjags)
library(reshape2)
mu.yr = dcast(data=museumeverything,Year~`Disease_St`,value.var='Decade',fun.aggregate=length)
names(mu.yr)[c(2,3)] = c('neg','pos')

mu.yr$tot = mu.yr$neg+mu.yr$pos
write.csv(mu.yr,'YearTable.csv')

# Estimate time of arrival
# use jags and rjags

library(runjags)
library(rjags)

mu.yr$yrc = mu.yr$Year-1893

# establish data

inf = mu.yr$pos
n = mu.yr$tot
time = mu.yr$yr
nrows = nrow(mu.yr)

# create model

model_string = 'model{ for(ii in 1:nrows){ inf[ii]~dbin(p[ii],n[ii]) p[ii]<-ppres[ii]*mu ppres[ii]<-step(tst[ii]) tst[ii]<-time[ii]-arr.time} arr.time~dunif(-48,60) mu~dbeta(1,1)}'

arr.time = jags.model(textConnection(model_string), data = list('inf' = inf,'n' = n, 'time' = time,  'nrows'=nrows), n.chains = 3, n.adapt = 10000)


update(arr.time,10000)

arr.time_samples = coda.samples(arr.time,c('arr.time','mu'),n.iter=20000)

plot(arr.time_samples)

summary(arr.time_samples)



########################################





mu = read.csv('museumeverything.csv',header=T,sep=',')


mu.dec=dcast(data=mu,Year~Disease_St,value.var='Year',fun.aggregate=length)
names(mu.dec)[c(2,3)]=c('neg','pos')

mu.dec
Year neg pos
1   1893  12   0
2   1894  10   0
3   1895   5   0
4   1896   1   0
5   1897  28   0
6   1898   6   0
7   1903   1   0
8   1904   4   0
9   1906   1   0
10  1907   8   0
11  1908   8   0
12  1909   5   0
13  1910  11   0
14  1911  45   0
15  1912  11   0
16  1913  20   0
17  1914   1   0
18  1915   3   0
19  1916   1   0
20  1917   4   0
21  1918  13   0
22  1919   1   0
23  1920   3   0
24  1922   3   0
25  1923  10   0
26  1924   3   0
27  1925   1   0
28  1926  15   0
29  1927   7   0
30  1928  12   0
31  1929   7   0
32  1930   3   0
33  1932  10   0
34  1933   7   0
35  1934  34   0
36  1935   9   0
37  1936   5   0
38  1937  58   0
39  1938  16   0
40  1939  30   0
41  1940  41   0
42  1941  23   0
43  1942  20   0
44  1943  25   0
45  1944  22   0
46  1945  10   0
47  1946  22   0
48  1947  17   0
49  1948  12   1
50  1949  16   0
51  1950  14   1
52  1951  28   1
53  1952  52   0
54  1953  62   0
55  1954  10   0
56  1955  20   0
57  1956  18   0
58  1957  23   0
59  1958   6   0
60  1959  26   0
61  1960  11   0
62  1961  28   1
63  1962  51   3
64  1963  12   1
65  1964  17   0
66  1965  11   0
67  1966   5   0
68  1967  17   0
69  1968  17   0
70  1969  17   0
71  1970  40   0
72  1971  35   1
73  1972  13   0
74  1973  19   0
75  1974  13   0
76  1975  12   2
77  1976   9   1
78  1977  21   0
79  1978  11   0
80  1979   2   0
81  1980  12   0
82  1981  20   0
83  1982  26   0
84  1983  18   0
85  1984  20   1
86  1985  12   0
87  1986  12   1
88  1987  36   7
89  1988  25   2
90  1989  25   1
91  1990  39   1
92  1991  36   2
93  1992  54   4
94  1993   6   0
95  1995   9   0
96  1996  11   0
97  1997  11   2
98  1998  24   3
99  1999  23   3
100 2000  23   1
101 2001  21  10
102 2002   5   1
103 2003  53   4
104 2004   5   0
105 2005   5   1
106 2006   3   0
107 2007   1   0
108 2008   5   0
109 2010   8   0
110 2011   3   0
111 2012   6   0
112 2013   4   0
113 2014   6   0
114 2015   9   2

mu.dec$tot=mu.dec$neg+mu.dec$pos
mu.dec$lower=NA
mu.dec$upper=NA

for (i in 1:nrow(mu.dec)){
mu.dec$lower[i]=binom.test(mu.dec$pos[i],mu.dec$tot[i])$conf.int[1]
mu.dec$upper[i]=binom.test(mu.dec$pos[i],mu.dec$tot[i])$conf.int[2]
}

mu.dec
Year neg pos tot        lower      upper
1   1893  12   0  12 0.0000000000 0.26464847
2   1894  10   0  10 0.0000000000 0.30849711
3   1895   5   0   5 0.0000000000 0.52182375
4   1896   1   0   1 0.0000000000 0.97500000
5   1897  28   0  28 0.0000000000 0.12343612
6   1898   6   0   6 0.0000000000 0.45925813
7   1903   1   0   1 0.0000000000 0.97500000
8   1904   4   0   4 0.0000000000 0.60236464
9   1906   1   0   1 0.0000000000 0.97500000
10  1907   8   0   8 0.0000000000 0.36941665
11  1908   8   0   8 0.0000000000 0.36941665
12  1909   5   0   5 0.0000000000 0.52182375
13  1910  11   0  11 0.0000000000 0.28491415
14  1911  45   0  45 0.0000000000 0.07870510
15  1912  11   0  11 0.0000000000 0.28491415
16  1913  20   0  20 0.0000000000 0.16843347
17  1914   1   0   1 0.0000000000 0.97500000
18  1915   3   0   3 0.0000000000 0.70759823
19  1916   1   0   1 0.0000000000 0.97500000
20  1917   4   0   4 0.0000000000 0.60236464
21  1918  13   0  13 0.0000000000 0.24705264
22  1919   1   0   1 0.0000000000 0.97500000
23  1920   3   0   3 0.0000000000 0.70759823
24  1922   3   0   3 0.0000000000 0.70759823
25  1923  10   0  10 0.0000000000 0.30849711
26  1924   3   0   3 0.0000000000 0.70759823
27  1925   1   0   1 0.0000000000 0.97500000
28  1926  15   0  15 0.0000000000 0.21801936
29  1927   7   0   7 0.0000000000 0.40961640
30  1928  12   0  12 0.0000000000 0.26464847
31  1929   7   0   7 0.0000000000 0.40961640
32  1930   3   0   3 0.0000000000 0.70759823
33  1932  10   0  10 0.0000000000 0.30849711
34  1933   7   0   7 0.0000000000 0.40961640
35  1934  34   0  34 0.0000000000 0.10281792
36  1935   9   0   9 0.0000000000 0.33626712
37  1936   5   0   5 0.0000000000 0.52182375
38  1937  58   0  58 0.0000000000 0.06162101
39  1938  16   0  16 0.0000000000 0.20590721
40  1939  30   0  30 0.0000000000 0.11570331
41  1940  41   0  41 0.0000000000 0.08604384
42  1941  23   0  23 0.0000000000 0.14818513
43  1942  20   0  20 0.0000000000 0.16843347
44  1943  25   0  25 0.0000000000 0.13718517
45  1944  22   0  22 0.0000000000 0.15437251
46  1945  10   0  10 0.0000000000 0.30849711
47  1946  22   0  22 0.0000000000 0.15437251
48  1947  17   0  17 0.0000000000 0.19506432
49  1948  12   1  13 0.0019456285 0.36029744
50  1949  16   0  16 0.0000000000 0.20590721
51  1950  14   1  15 0.0016864302 0.31948457
52  1951  28   1  29 0.0008726469 0.17764430
53  1952  52   0  52 0.0000000000 0.06848221
54  1953  62   0  62 0.0000000000 0.05776263
55  1954  10   0  10 0.0000000000 0.30849711
56  1955  20   0  20 0.0000000000 0.16843347
57  1956  18   0  18 0.0000000000 0.18530197
58  1957  23   0  23 0.0000000000 0.14818513
59  1958   6   0   6 0.0000000000 0.45925813
60  1959  26   0  26 0.0000000000 0.13227460
61  1960  11   0  11 0.0000000000 0.28491415
62  1961  28   1  29 0.0008726469 0.17764430
63  1962  51   3  54 0.0116067744 0.15388503
64  1963  12   1  13 0.0019456285 0.36029744
65  1964  17   0  17 0.0000000000 0.19506432
66  1965  11   0  11 0.0000000000 0.28491415
67  1966   5   0   5 0.0000000000 0.52182375
68  1967  17   0  17 0.0000000000 0.19506432
69  1968  17   0  17 0.0000000000 0.19506432
70  1969  17   0  17 0.0000000000 0.19506432
71  1970  40   0  40 0.0000000000 0.08809730
72  1971  35   1  36 0.0007030252 0.14528926
73  1972  13   0  13 0.0000000000 0.24705264
74  1973  19   0  19 0.0000000000 0.17646691
75  1974  13   0  13 0.0000000000 0.24705264
76  1975  12   2  14 0.0177945155 0.42812916
77  1976   9   1  10 0.0025285785 0.44501612
78  1977  21   0  21 0.0000000000 0.16109762
79  1978  11   0  11 0.0000000000 0.28491415
80  1979   2   0   2 0.0000000000 0.84188612
81  1980  12   0  12 0.0000000000 0.26464847
82  1981  20   0  20 0.0000000000 0.16843347
83  1982  26   0  26 0.0000000000 0.13227460
84  1983  18   0  18 0.0000000000 0.18530197
85  1984  20   1  21 0.0012048834 0.23815991
86  1985  12   0  12 0.0000000000 0.26464847
87  1986  12   1  13 0.0019456285 0.36029744
88  1987  36   7  43 0.0680520945 0.30701087
89  1988  25   2  27 0.0091000729 0.24289835
90  1989  25   1  26 0.0009732879 0.19636965
91  1990  39   1  40 0.0006327449 0.13158586
92  1991  36   2  38 0.0064387167 0.17749059
93  1992  54   4  58 0.0191093119 0.16726813
94  1993   6   0   6 0.0000000000 0.45925813
95  1995   9   0   9 0.0000000000 0.33626712
96  1996  11   0  11 0.0000000000 0.28491415
97  1997  11   2  13 0.0192066720 0.45447106
98  1998  24   3  27 0.0235274544 0.29158692
99  1999  23   3  26 0.0244580753 0.30154040
100 2000  23   1  24 0.0010543524 0.21120168
101 2001  21  10  31 0.1668236374 0.51372983
102 2002   5   1   6 0.0042107445 0.64123458
103 2003  53   4  57 0.0194504207 0.17003982
104 2004   5   0   5 0.0000000000 0.52182375
105 2005   5   1   6 0.0042107445 0.64123458
106 2006   3   0   3 0.0000000000 0.70759823
107 2007   1   0   1 0.0000000000 0.97500000
108 2008   5   0   5 0.0000000000 0.52182375
109 2010   8   0   8 0.0000000000 0.36941665
110 2011   3   0   3 0.0000000000 0.70759823
111 2012   6   0   6 0.0000000000 0.45925813
112 2013   4   0   4 0.0000000000 0.60236464
113 2014   6   0   6 0.0000000000 0.45925813
114 2015   9   2  11 0.0228311983 0.51775585



# calculate probability of getting no positives, given an expected detection rate of 11%

mu.dec$prob =  dbinom(0,mu.dec$tot,.11)

#write table

write.csv(mu.dec,'DecadeTable_MC.csv')

# calculate CI for total

binom.test(35,937)


mu.dec2=dcast(data=mu,Decade~Disease_St,value.var='Year',fun.aggregate=length)
names(mu.dec2)[c(2,3)]=c('neg','pos')
mu.dec2$tot=mu.dec2$neg+mu.dec2$pos
mu.dec2$lower=NA
mu.dec2$upper=NA

for (i in 1:nrow(mu.dec2)){
  mu.dec2$lower[i]=binom.test(mu.dec2$pos[i],mu.dec2$tot[i])$conf.int[1]
  mu.dec2$upper[i]=binom.test(mu.dec2$pos[i],mu.dec2$tot[i])$conf.int[2]
}

mu.dec2$prob =  dbinom(0,mu.dec2$tot,.11)
write.csv(mu.dec2,'DecadeTable_SC.csv')
binom.test(35,937)


